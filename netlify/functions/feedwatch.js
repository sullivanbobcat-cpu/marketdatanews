// netlify/functions/feedwatch.js
// Data embedded directly — no filesystem dependency

const DATA = {"version":"1.0","generated":"2026-02-28","entries":[{"id":"FW-2026-019","title":"CFTC Large Trader Reporting — New FIXML Position Message Format Live March 2025","organization":"CFTC","category":"Regulatory Deadline","region":"US","impact":"medium","action_required":true,"impact_type":"Compliance, Reporting","announced_date":"2024-04-30","effective_date":"2025-03-10","summary":"CFTC final rules amending Large Trader Reporting regulations for Futures and Options took effect in April 2024. CME Group began accepting new Position Message FIXML format files via SFTP on March 10, 2025. Firms must use new FIXML format including Unique Instrument Code (UIC) fields.","tags":["CFTC","large trader reporting","FIXML","futures","UIC"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/10/20251013.html"},{"id":"FW-2026-007","title":"NYSE Port Fee Increase — MDC Co-location Connectivity (Up to 11.1%)","organization":"NYSE","category":"Billing Change","region":"US","impact":"low","action_required":false,"impact_type":"Billing","announced_date":"2025-09-25","effective_date":"2025-10-01","summary":"NYSE filed proposed rule change SR-NYSE-2025-37 to increase monthly recurring port fees for co-location hall connections at the MDC by up to 11.1%. First fee increase since 2017. Changes took effect October 2025.","tags":["NYSE","co-location","port fees","MDC","connectivity"],"source_url":"https://www.federalregister.gov/documents/2025/09/30/2025-18952"},{"id":"FW-2026-005","title":"CME Globex: Variable Tick Expansion to Four Levels for S&P 500, Nasdaq-100, Russell 2000 Options","organization":"CME Group","category":"Spec Update","region":"US","impact":"medium","action_required":true,"impact_type":"Protocol, Market Data","announced_date":"2025-10-27","effective_date":"2026-01-01","summary":"CME Group will expand variable ticks from two levels to four levels for S&P 500, Nasdaq-100, and Russell 2000 options on CME Globex starting January 2026. Firms must cancel all GTC and GTD orders before each product's production launch.","tags":["CME","Globex","options","variable tick","S&P 500"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/10/20251027a.html"},{"id":"FW-2026-008","title":"Nasdaq PHLX Technology Migration — SQF, FIX Port Transition Period","organization":"NASDAQ","category":"Port Migration","region":"US","impact":"high","action_required":true,"impact_type":"Connectivity, Billing","announced_date":"2025-08-04","effective_date":"2026-01-01","summary":"Nasdaq PHLX is migrating to new technology infrastructure. Legacy duplicate ports not returned by December 31, 2025 will be billed at standard rates from January 1, 2026. Members should review port inventory and return unneeded legacy ports before year-end.","tags":["NASDAQ","PHLX","SQF","FIX","OTTO"],"source_url":"https://www.federalregister.gov/documents/2025/08/04/2025-14674"},{"id":"FW-2026-009","title":"FINRA 2026 Annual Regulatory Oversight Report — CAT Compliance Priorities","organization":"FINRA","category":"Regulatory Deadline","region":"US","impact":"medium","action_required":true,"impact_type":"Compliance","announced_date":"2025-12-09","effective_date":"2026-01-01","summary":"FINRA released its 2026 Regulatory Oversight Report emphasizing CAT compliance as a top priority. Key findings include incomplete submission of reportable events, failure to timely repair errors, and inaccurate reporting.","tags":["FINRA","CAT","NMS Plan","compliance","CAIS"],"source_url":"https://www.finra.org/rules-guidance/guidance/reports/2026-finra-annual-regulatory-oversight-report"},{"id":"FW-2026-010","title":"FINRA Rule 6830 Amendment — CAT Reporting of Bona Fide Market Making (BFMM) Locate Exception","organization":"FINRA","category":"Regulatory Deadline","region":"US","impact":"medium","action_required":true,"impact_type":"Compliance","announced_date":"2025-12-12","effective_date":"2026-01-01","summary":"FINRA filed SR-FINRA-2025-016 to amend Rule 6830 to require CAT reporting of reliance on the Bona Fide Market Making Locate Exception under Regulation SHO Rule 203(b)(2)(iii).","tags":["FINRA","CAT","Rule 6830","Reg SHO","BFMM"],"source_url":"https://www.federalregister.gov/documents/2025/12/31/2025-24048"},{"id":"FW-2026-014","title":"FINRA SLATE Reporting Launch — Securities Lending Transaction Data (Rule 10c-1a)","organization":"FINRA","category":"Regulatory Deadline","region":"US","impact":"high","action_required":true,"impact_type":"Compliance, Reporting","announced_date":"2025-01-24","effective_date":"2026-01-02","summary":"FINRA's SLATE reporting system under Rule 10c-1a launched January 2, 2026. Covered persons must report securities loan transaction data to SLATE. Published data will begin appearing within 90 days of the reporting start date.","tags":["FINRA","SLATE","Rule 10c-1a","securities lending","transparency"],"source_url":"https://www.finra.org/rules-guidance/rulebooks/finra-rules/6500"},{"id":"FW-2026-003","title":"CME Globex iLink SBE Schema Update to Version 9","organization":"CME Group","category":"Protocol Update","region":"US","impact":"high","action_required":true,"impact_type":"Protocol","announced_date":"2025-11-17","effective_date":"2026-01-25","summary":"CME Group will update the iLink SBE schema to version 9 on January 25, 2026. New schema files support Template Extension for iLink messages. Firms must update parser implementations before the production launch date.","tags":["CME","Globex","iLink","SBE","schema"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/11/20251117.html"},{"id":"FW-2026-018","title":"CME Globex: BrokerTec Chicago CLOB Launch — New GLink Connectivity Required","organization":"CME Group","category":"New Product / Connectivity","region":"US","impact":"low","action_required":false,"impact_type":"Connectivity","announced_date":"2025-10-06","effective_date":"2026-02-01","summary":"CME Group launched BrokerTec Chicago, a secondary U.S. Treasury Actives CLOB on CME Globex in Aurora, IL. A new BrokerTec Chicago GLink is available for dedicated connectivity.","tags":["CME","BrokerTec","US Treasury","CLOB","GLink"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/10/20251020.html"},{"id":"FW-2026-015","title":"Form 13H Annual Update — Large Trader Reporting Deadline (February 17, 2026)","organization":"SEC","category":"Regulatory Deadline","region":"US","impact":"low","action_required":true,"impact_type":"Compliance","announced_date":"2026-01-01","effective_date":"2026-02-17","summary":"Annual update of Form 13H is due February 17, 2026, for large traders that exercised investment discretion over NMS securities equal to or greater than 2 million shares or $20 million in any calendar day during 2025.","tags":["SEC","Form 13H","large trader","NMS","annual filing"],"source_url":"https://www.sec.gov/forms/form-13h"},{"id":"FW-2026-002","title":"CME Globex: 1Gbps Connections Will No Longer Support MDP 3 Multicast Market Data","organization":"CME Group","category":"Feed Change","region":"US","impact":"high","action_required":true,"impact_type":"Connectivity, Market Data","announced_date":"2025-10-13","effective_date":"2026-03-01","summary":"Effective March 2026, 1Gbps connections will no longer support MDP 3 multicast market data on CME Globex. Firms currently receiving multicast market data on 1Gbps connections must upgrade to 10Gbps.","tags":["CME","Globex","MDP 3.0","multicast","1Gbps"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/10/20251013.html"},{"id":"FW-2026-017","title":"Nasdaq Nordic NLS Specification 1.2.10 — Valid from March 2, 2026","organization":"NASDAQ","category":"Spec Update","region":"EU","impact":"medium","action_required":true,"impact_type":"Protocol","announced_date":"2026-01-01","effective_date":"2026-03-02","summary":"Nasdaq Nordic will deploy updated NLS protocol specification version 1.2.10 effective March 2, 2026. Firms consuming NLS data feeds from Nasdaq Nordic and Baltic markets should review the updated specification.","tags":["NASDAQ","Nordic","NLS","protocol spec","last sale"],"source_url":"https://www.nasdaq.com/solutions/inet-nordic-protocol-specifications"},{"id":"FW-2026-020","title":"CME Globex: Implied Functionality Enabled for New Options Products (March 2026)","organization":"CME Group","category":"Spec Update","region":"US","impact":"low","action_required":false,"impact_type":"Market Data","announced_date":"2025-12-29","effective_date":"2026-03-02","summary":"Effective March 2, 2026, CME Group will enable implied functionality for additional futures and options on CME Globex. Firms consuming CME options market data should review implied pricing handling in feed processors.","tags":["CME","Globex","implied functionality","options","market data"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/12/20251229.html"},{"id":"FW-2026-016","title":"CME Globex: Network Connectivity Update for Market Segment 74 (24/7 Trading Preparation)","organization":"CME Group","category":"Feed Change","region":"US","impact":"high","action_required":true,"impact_type":"Connectivity, Protocol","announced_date":"2025-10-20","effective_date":"2026-Q1","summary":"In Q1 2026, CME Group will update iLink, Drop Copy, and MDP 3.0 Production network connectivity for Market Segment 74 to prepare for 24/7 trading. Firms must migrate IP configurations for MSGW iLink and Drop Copy sessions.","tags":["CME","Globex","24/7 trading","iLink","Drop Copy"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/10/20251020.html"},{"id":"FW-2026-006","title":"CME Globex: New Market Data Multicast Group — Channel ID 324 (Q1 2026)","organization":"CME Group","category":"Feed Change","region":"US","impact":"medium","action_required":true,"impact_type":"Market Data, Connectivity","announced_date":"2025-12-29","effective_date":"2026-Q1","summary":"CME Group will launch a new market data multicast group in Q1 2026 using Channel ID 324. A second group with Channel ID 335 is planned for H1 2026. Firms should update firewall policies and network configurations proactively.","tags":["CME","Globex","multicast","MDP 3.0","channel ID"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/12/20251229.html"},{"id":"FW-2026-004","title":"CME Globex: End-of-Life Network Equipment Replacement at Globex Hubs","organization":"CME Group","category":"Infrastructure Maintenance","region":"US","impact":"medium","action_required":false,"impact_type":"Connectivity","announced_date":"2025-10-20","effective_date":"2026-04-01","summary":"Starting April 2026, CME Group will replace end-of-life network equipment at CME Globex Hubs. Copper handoffs will no longer be supported. Customers will be notified individually if their connectivity is impacted.","tags":["CME","Globex","network","infrastructure","copper handoff"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/10/20251020.html"},{"id":"FW-2026-012","title":"Regulation S-P Cybersecurity Amendments — Smaller RIA Compliance Deadline","organization":"SEC","category":"Regulatory Deadline","region":"US","impact":"high","action_required":true,"impact_type":"Compliance","announced_date":"2024-05-16","effective_date":"2026-06-03","summary":"SEC Regulation S-P cybersecurity amendments require SEC-registered investment advisers with less than $1.5 billion AUM to implement written incident response programs by June 3, 2026.","tags":["SEC","Regulation S-P","cybersecurity","RIA","safeguards rule"],"source_url":"https://www.sec.gov/rules-regulations/2024/05/34-100155"},{"id":"FW-2026-011","title":"Rule 605 NMS Plan Amendment — Expanded Execution Quality Reporting (Effective August 2026)","organization":"SEC","category":"Regulatory Deadline","region":"US","impact":"high","action_required":true,"impact_type":"Compliance, Reporting","announced_date":"2025-09-01","effective_date":"2026-08-01","summary":"The SEC approved Rule 605 NMS Plan amendments expanding reporting scope to include larger broker-dealers and adding a summary execution quality report requirement. Compliance deadline is August 1, 2026.","tags":["SEC","Rule 605","NMS Plan","execution quality","broker-dealer"],"source_url":"https://www.finra.org/rules-guidance/guidance/national-market-system-plans"},{"id":"FW-2026-013","title":"CAT NMS Plan Amendment — CAIS Customer Information Reporting Elimination (Pending SEC Approval)","organization":"SEC","category":"Regulatory Deadline","region":"US","impact":"medium","action_required":false,"impact_type":"Compliance, Reporting","announced_date":"2025-03-13","effective_date":"2026-TBD","summary":"CAT LLC filed a proposed amendment to eliminate CAT NMS Plan requirements for Industry Members to report customer names, addresses, and years of birth. If approved, this would reduce CAIS reporting obligations significantly.","tags":["CAT","NMS Plan","CAIS","SEC","customer information"],"source_url":"https://www.finra.org/rules-guidance/guidance/reports/2026-finra-annual-regulatory-oversight-report/cat"},{"id":"FW-2026-001","title":"CME Globex Migration to Google Cloud — Preview Phase Launch","organization":"CME Group","category":"Infrastructure Migration","region":"US","impact":"critical","action_required":true,"impact_type":"Connectivity, Protocol","announced_date":"2025-10-27","effective_date":"2026-Q2","summary":"CME Group and Google Cloud announced a private Google Cloud Chicago region for CME Group listed derivative markets. Preview phase launches Q2 2026. Clients must plan for iLink, Drop Copy, and MDP 3.0 IP configuration migrations.","tags":["CME","Globex","Google Cloud","iLink","MDP 3.0"],"source_url":"https://www.cmegroup.com/notices/electronic-trading/2025/10/20251027a.html"}]};

exports.handler = async function(event) {
  const headers = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, OPTIONS',
    'Cache-Control': 'public, max-age=300, s-maxage=300',
    'X-API-Version': '1.0',
    'X-Data-Source': 'FeedWatch by Market Data News',
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  let entries = [...DATA.entries];
  const params = event.queryStringParameters || {};

  if (params.impact) {
    const levels = params.impact.toLowerCase().split(',').map(s => s.trim());
    entries = entries.filter(e => levels.includes(e.impact.toLowerCase()));
  }
  if (params.org) {
    const orgs = params.org.toLowerCase().split(',').map(s => s.trim());
    entries = entries.filter(e => orgs.includes(e.organization.toLowerCase()));
  }
  if (params.category) {
    const cats = params.category.toLowerCase().split(',').map(s => s.trim());
    entries = entries.filter(e => cats.some(c => e.category.toLowerCase().includes(c)));
  }
  if (params.action_required !== undefined) {
    entries = entries.filter(e => e.action_required === (params.action_required === 'true'));
  }
  if (params.region) {
    const regions = params.region.toUpperCase().split(',').map(s => s.trim());
    entries = entries.filter(e => regions.includes(e.region.toUpperCase()));
  }

  entries.sort((a, b) => {
    const parse = (v) => {
      if (!v) return 9999999999999;
      if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return new Date(v).getTime();
      const q = v.match(/(\d{4})-Q(\d)/);
      if (q) return new Date(`${q[1]}-${['01','04','07','10'][+q[2]-1]}-01`).getTime();
      return 9999999999999;
    };
    return parse(a.effective_date) - parse(b.effective_date);
  });

  if (params.limit) {
    const n = parseInt(params.limit, 10);
    if (n > 0) entries = entries.slice(0, n);
  }

  return {
    statusCode: 200,
    headers,
    body: JSON.stringify({
      version: DATA.version,
      generated: DATA.generated,
      total: DATA.entries.length,
      returned: entries.length,
      filters: Object.keys(params).filter(k => k !== 'limit'),
      entries,
    }, null, 2),
  };
};
